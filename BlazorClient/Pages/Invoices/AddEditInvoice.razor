@page "/invoices/add"
@page "/invoices/edit/{id:guid}"
@inject InvoiceService InvoiceService
@inject TaxService TaxService
@inject CustomerService CustomerService
@inject ItemService ItemService
@inject NavigationManager NavigationManager
    
<h3 class="text-center mb-4">Create Invoice</h3>

    <EditForm Model="invoice" OnValidSubmit="SaveInvoice">
        <DataAnnotationsValidator />
        <ValidationSummary />
        <div class="row g-3 mb-4">
            <div class="col-md-4">
                <label for="type" class="form-label">Type:</label>
                <InputSelect id="type" @bind-Value="invoice.Type" class="form-select">
                    @foreach (var type in Enum.GetValues(typeof(InvoiceType)))
                    {
                    <option value="@((int)type)">@type.ToString()</option>
                    }
                </InputSelect>
            </div>
            <div class="col-md-4">
                <label for="code" class="form-label">Invoice Code:</label>
                <InputText id="code" @bind-Value="invoice.Code" class="form-control" />
            </div>
            <div class="col-md-4">
                <label for="customer" class="form-label">Customer:</label>
                <InputSelect id="customer" @bind-Value="invoice.CustomerId" @oninput="OnCustomerSearchChanged" class="form-control">
                    @foreach (var customer in customers)
                    {
                        <option value="@customer.Id">@customer.Name</option>
                    }
                </InputSelect>
                <ul>
                    @foreach (var customer in filteredCustomers)
                    {
                        <li @onclick="() => SelectCustomer(customer)">@customer.Name</li>
                    }
                </ul>
            </div>
            <div class="col-md-4">
                <label class="form-label" for="date">Date Issued:</label>
                <InputDate id="date" @bind-Value="invoice.DateTimeIssued" class="form-control" />
            </div>
        </div>
    
    <div class="mb-4">
        <h4>Items</h4>
        <button type="button" class="btn btn-success mt-3" @onclick="AddNewItem">Add New Item</button>
        @for (int i = 0; i < invoice.InvoiceItems.Count; i++)
        {
            <InvoiceItemComponent @bind-Item="invoice.InvoiceItems[i]" OnRemove="RemoveItem"
                                  ItemsList="items"
                                  TaxList="taxes" />
        }
    </div>

    <div class="text-end">
        <label>Total Net Amount: </label>
        <span>@invoice.NetAmount</span>
    </div>

    <button type="submit" class="btn btn-primary">Submit Invoice</button>
    </EditForm>

@code {
    [Parameter]
    public Guid? Id { get; set; }
    private Invoice invoice = new Invoice();
    private string customerSearchTerm = "";
    private List<Customer> customers = new List<Customer>();
    private List<Customer> filteredCustomers = new List<Customer>();

    private List<Item> items = new List<Item>();
    private List<Tax> taxes = new List<Tax>();
    protected override async Task OnInitializedAsync()
    {
        if (Id.HasValue)
        {
            // If there is an Id, fetch the existing invoice for editing
            invoice = await InvoiceService.GetInvoiceyIdAsync(Id.Value);
        }
        else
        {
            // If no Id, create a new invoice for adding
            invoice = new Invoice();
        }
        // Load customers, items, and taxes from the services
        customers = await CustomerService.GetCustomersAsync();
        items = await ItemService.GetItemsAsync();
        taxes = await TaxService.GetTaxesAsync();
    }
    private void OnCustomerSearchChanged(ChangeEventArgs e)
    {
        customerSearchTerm = e.Value.ToString();
        filteredCustomers = customers
            .Where(c => c.Name.Contains(customerSearchTerm, StringComparison.OrdinalIgnoreCase))
            .ToList();
    }
    private void SelectCustomer(Customer customer)
    {
        invoice.CustomerId = customer.Id;
        filteredCustomers.Clear(); // Hide the suggestions list
    }

    private void AddNewItem()
    {
        invoice.InvoiceItems.Add(new InvoiceItem());
    }

    private void RemoveItem(InvoiceItem item)
    {
        invoice.InvoiceItems.Remove(item);
    }
    private async Task SaveInvoice()
    {
        // Save invoice to backend using HttpClient
        await InvoiceService.AddInvoiceAsync(invoice);
    }
    private void HandleItemChanged(InvoiceItem updatedItem)
    {
        // Logic to handle item updates (e.g., recalculating totals)
    }
}
