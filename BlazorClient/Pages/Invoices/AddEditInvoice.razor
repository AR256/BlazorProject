@page "/invoices/add"
@page "/invoices/edit/{id:guid}"
@inject InvoiceService InvoiceService
@inject TaxService TaxService
@inject CustomerService CustomerService
@inject ItemService ItemService
@inject InvoiceTypeService InvoiceTypeService
@inject NavigationManager NavigationManager
<div class="p-2 bg-dark text-light rounded-3 border border-dark border-3">
    <h3 class="text-center mb-4">@((Id.HasValue ? "Edit" : "Create") + " Invoice")</h3>
    <EditForm Model="invoice" OnValidSubmit="SaveInvoice">
        <DataAnnotationsValidator />
        <ValidationSummary />
        <div class="row g-3 mb-4">
            <div class="col-md-6">
                <label for="type" class="form-label">Type:</label>
                <InputSelect id="item-name" class="form-select border border-1 border-dark" @bind-Value="invoice.InvoiceTypeId">
                    <option>--Select A Type--</option>
                    @foreach (var invoiceType in invoiceTypes)
                    {
                        <option value="@invoiceType.Id">@invoiceType.Name</option>
                    }
                </InputSelect>
            </div>
            <div class="col-md-6">
                <label for="code" class="form-label">Invoice Code:</label>
                <InputText id="code" @bind-Value="invoice.Code" class="form-control  border border-1 border-dark" disabled />
            </div>
            <div class="col-md-6">
                <label for="customer" class="form-label">Customer:</label>
                <InputSelect id="item-name" class="form-select border border-1 border-dark" @bind-Value="invoice.CustomerId">
                    <option>--Select A Customer--</option>
                    @foreach (var customer in customers)
                    {
                        <option value="@customer.Id">@customer.Name</option>
                    }
                </InputSelect>
            </div>
            <div class="col-md-6">
                <label class="form-label" for="date">Date Issued:</label>
                <input type="datetime-local" @bind="invoice.DateTimeIssued" class="form-control border border-1 border-dark" disabled />
            </div>
        </div>

        <button type="button" class="btn btn-light mb-3" @onclick="AddNewItem">Add Item</button>
        <div class="mb-4 rounded-3 border border-dark border-3">
            <InvoiceItemComponent Items="invoice.InvoiceItems"
            OnRemove="RemoveItem"
            ItemsList="items"
            TaxList="taxes"
            ItemsChanged="RecalculateInvoiceNetAmount" />
            <div class="text-dark me-3 p-1 bg-success fw-bolder w-100 text-center d-flex justify-content-start gap-1">
                <label class="text-white fs-4">Total Net Amount: </label>
                <span class="bg-black text-light fs-4"> @invoice.NetAmount.ToString("C")</span>
            </div>
        </div>

        

        <div class="d-flex justify-content-start gap-2 mt-3">
            <button type="submit" class="btn btn-light">Submit Invoice</button>
            <button type="button" class="btn btn-light" @onclick="GoBack">Back</button>
        </div>
    </EditForm>
</div>

@code {
    [Parameter]
    public Guid? Id { get; set; }
    private Invoice invoice = new Invoice();
    private List<Customer> customers = new List<Customer>();
    private List<Item> items = new List<Item>();
    private List<Tax> taxes = new List<Tax>();
    private List<InvoiceType> invoiceTypes = new List<InvoiceType>();

    protected override async Task OnInitializedAsync()
    {
        if (Id.HasValue)
        {
            invoice = await InvoiceService.GetInvoiceyIdAsync(Id.Value);
        }
        else
        {
            invoice = new Invoice();
        }
        customers = await CustomerService.GetCustomersAsync();
        items = await ItemService.GetItemsAsync();
        taxes = await TaxService.GetTaxesAsync();
        invoiceTypes = await InvoiceTypeService.GetInvoiceTypesAsync();
    }
    private void RecalculateInvoiceNetAmount()
    {
        StateHasChanged();
    }
    private async Task GenerateInvoiceCode()
    {
        var invoices = await InvoiceService.GetAllInvoicesAsync();
        invoice.Code = $"INV-{invoice.DateTimeIssued:yyyyMMddHHmmss}{(invoices.Count + 1).ToString("D2")}";
    }

    private void AddNewItem()
    {
        invoice.InvoiceItems.Add(new InvoiceItem() { CreationDate = DateTime.Now, ModificationDate = DateTime.Now });
        StateHasChanged();
    }

    private void RemoveItem(InvoiceItem item)
    {
        invoice.InvoiceItems.Remove(item);
        StateHasChanged();
    }

    private async Task SaveInvoice()
    {
        if (Id.HasValue)
        {
            invoice.ModificationDate = DateTime.Now;
            await InvoiceService.UpdateInvoiceAsync(invoice);
        }
        else
        {
            invoice.DateTimeIssued = DateTime.Now;
            await GenerateInvoiceCode();
            await InvoiceService.AddInvoiceAsync(invoice);
        }
        NavigationManager.NavigateTo("/invoices");
    }

    private void GoBack()
    {
        NavigationManager.NavigateTo("/invoices");
    }
}
